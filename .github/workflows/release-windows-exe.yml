name: Release Windows EXE

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows-exe:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install . pyinstaller

      - name: Run tests
        env:
          PYTHONPATH: src
        run: python -m unittest discover -s tests -v

      - name: Build Windows executable
        run: |
          pyinstaller --noconfirm --clean --onefile --name sudoku-pdf --paths src --collect-all reportlab src/sudoku_pdf/__main__.py

      - name: Create release zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release-assets | Out-Null
          Compress-Archive -Path dist/sudoku-pdf.exe -DestinationPath release-assets/sudoku-pdf-windows-x64.zip -Force

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sudoku-pdf-windows-x64
          path: release-assets/sudoku-pdf-windows-x64.zip

      - name: Publish asset to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: main-latest
          target_commitish: ${{ github.sha }}
          name: Main Latest Build
          prerelease: true
          make_latest: false
          files: release-assets/sudoku-pdf-windows-x64.zip
          overwrite_files: true
